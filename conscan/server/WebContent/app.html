<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
		<title>ConScan</title>
		<link type="text/css" rel="stylesheet" href="css/conscan.css">
		<link type="text/css" rel="stylesheet" href="css/app.css">
		<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
		<script type="text/javascript" src="js/jquery.simplemodal.1.4.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.form.js"></script>
	</head>
	<body>
		<h1>ConScan</h1>
		<div class="login">
			<span id="loginlink">Login</span>
			<span id="logout">&nbsp;|&nbsp;<span id="logoutlink" class="clickablelink">Logout</span></span>
		</div>
		<div class="main curvedblock">
			<div class="menu">
				<h3>Menu</h3>
				<ul>
					<li class="curvedblocksmall linkable">Staff</li>
					<li class="curvedblocksmall linkable">Other</li>
				</ul>
			</div>
			<div class="field">
				<h3 id="fieldtitle">ConScan</h3>
				<div id="fieldcontent"></div>
			</div>
			<div class="clear"></div>
		</div>
		<div class="footer">
			&copy; 2001 Tipping Point Software Solutions
		</div>
		<div class="hidden wideborder curvedblock" id="logindialog">
			<div class="errormsg"></div>
			<form id="logindialogform">
				<table class="noborder">
					<tbody>
					<tr>
						<td>User:</td>
						<td><input type="text" name="user"></input></td>
					</tr>
					<tr>
						<td>Password:</td>
						<td><input type="password" name="password"></input></td>
					</tr>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="2">
								<input type="reset" value="Clear"></input>
								<input type="submit" value="Submit" class="loginsubmit"></input>
							</td>
						</tr>
					</tfoot>
				</table>
			</form>
		</div>
		<script type="text/javascript">
			jQuery('#loginlink').live('click', showlogin);
			jQuery('#logoutlink').live('click', logout);
			jQuery('div.menu .linkable').live('click', menuitemclick);

			function menuitemclick(event) {
				var menuitem = event.target.innerHTML;

				// set the title of the field to the same as the menu item
				jQuery('#fieldtitle').html(menuitem);

				// get the item list based on the menu item
				menuitem = menuitem.toLowerCase();
				getItemList(menuitem);
			}

			function getItemList(item) {
				//alert('getItemList: ' + item);
				jQuery.ajax({
					url: item,
					type: 'GET',
					dataType: 'xml',
					success: displaylist,
					error: function(responseXML, statusText, xhr, form) {
						alert('Item ' + item + ' error: ' + statusText);
					} 
				});
			}

			function loginsuccess(responseXML, statusText, xhr, form) {
//				alert('login success: ' + statusText);
				processUser(responseXML);
				jQuery.modal.close();
			}

			function loginerror(responseXML, statusText, xhr, form) {
				if (204 == responseXML.status) {
					seterrormsg('Invalid login. Please try again.');
				}
				else {
					alert('login error: ' + statusText + "-" + xhr.responseText);
				}
			}

			function seterrormsg(message) {
				jQuery('div.errormsg').html('Invalid login. Please try again.');
			}

			function onshowlogin() {
				// prepare Options Object 
				var options = {
					url: 'user',
					type: 'PUT',
					dataType: 'xml',
					success: loginsuccess,
					error: loginerror
				}; 

				// pass options to ajaxForm 
				jQuery('#logindialogform').ajaxForm(options);
			}

			function showlogin() {
				jQuery("#logindialog").modal({
					opacity:70,
					overlayCss: {
						backgroundColor:"#EEEEEE"
					},
					onShow: onshowlogin
				});
			}

			function logout() {
				jQuery.ajax({
					url: 'user',
					type: 'DELETE',
					success: function() {
						jQuery('span#loginlink').html('No User');
						
						checkLogin();
					},
					error: function(responseXML, statusText, xhr, form) {
						alert('logout error: ' + statusText);
					} 
				});
			}

			function processUser(xml) {
				var firstName;
				var lastName;
				
				jQuery(xml).find("field").each(function() {
					if (jQuery(this).attr('name') == "firstname") {
						firstName = jQuery(this).text();
					} else if (jQuery(this).attr('name') == "lastname") {
						lastName = jQuery(this).text();
					}
				});

				jQuery('span#loginlink').html(firstName + ' ' + lastName);
			}

			function checkLogin() {
				jQuery.ajax({
					url: 'user',
					type: 'GET',
					success: processUser,
					error: showlogin 
				});
			}

			var objectoptions = new Object();
			
			function getobjectoptions(name) {
				var options = objectoptions[name];

				if (typeof(options) == 'undefined') {
					jQuery.ajax({
						type: 'OPTIONS',
						url: 'database/' + name,
						datatype: 'json',
						async: false,
						beforeSend: function(req) {
							req.setRequestHeader("Accept", "application/json");
						},
						success: function(responseObj) {
							//alert('Retrieved options for ' + responseObj.table.name);
							objectoptions[name] = responseObj;
						},
						error: function(responseXML, statusText, xhr, form) {
							alert('Error getting options for ' + name + ': ' + statusText);
						} 
					});
				}

				return objectoptions[name];
			}

			function displaylist(responseXML, statusText, xhr) {
				var options;

				jQuery(responseXML).children("list").each(function() {
					options = getobjectoptions(jQuery(this).attr('name'));					
				});

				alert('options: ' + options.table.name); 

				jQuery('div#fieldcontent').html(options);
			}
			
			jQuery(document).ready(function() {
				// when the page first comes up, check for a logged in user
				checkLogin();
			});
		</script>
	</body>
</html>