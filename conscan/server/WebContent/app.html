<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
		<title>ConScan</title>
		<link type="text/css" rel="stylesheet" href="css/conscan.css">
		<link type="text/css" rel="stylesheet" href="css/app.css">
		<!--
		<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
		 -->
		<script type="text/javascript" src="js/jquery-1.4.4.js"></script>
		<script type="text/javascript" src="js/jquery.simplemodal.1.4.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.form.js"></script>
		<script type="text/javascript" src="js/jquery.dataTables.js"></script>
	</head>
	<body>
		<h1>ConScan</h1>
		<div class="login">
			<span id="loginlink">Login</span>
			<span id="logout">&nbsp;|&nbsp;<span id="logoutlink" class="clickablelink">Logout</span></span>
		</div>
		<div class="main curvedblock">
			<div class="menu">
				<h3>Menu</h3>
				<ul>
					<li class="curvedblocksmall linkable">staff</li>
					<li class="curvedblocksmall linkable">compliance</li>
					<li class="curvedblocksmall linkable">activity</li>
					<li class="curvedblocksmall linkable">location</li>
					<li class="curvedblocksmall linkable">offender</li>
					<li class="curvedblocksmall linkable">scannerlog</li>
				</ul>
			</div>
			<div class="field">
				<h3 id="fieldtitle">ConScan</h3>
				<div id="fieldcontent"></div>
			</div>
			<div class="clear"></div>
		</div>
		<div class="footer">
			&copy; 2011 Tipping Point Software Solutions
		</div>
		<div class="hidden wideborder curvedblock" id="logindialog">
			<div class="errormsg"></div>
			<form id="logindialogform">
				<table class="noborder">
					<tbody>
					<tr>
						<td>User:</td>
						<td><input type="text" name="user"></input></td>
					</tr>
					<tr>
						<td>Password:</td>
						<td><input type="password" name="password"></input></td>
					</tr>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="2">
								<input type="reset" value="Clear"></input>
								<input type="submit" value="Submit" class="loginsubmit"></input>
							</td>
						</tr>
					</tfoot>
				</table>
			</form>
		</div>
		<div class="hidden wideborder curvedblock" id="notesdialog">
			<div class="errormsg"></div>
			<form id="notesdialogform">
				<table class="noborder">
					<input type="hidden" name="scannerlogguid" value="asdf" id="idhiddenscannerlogguid"></input>		
					<tbody>
					<tr>
						<td>notes:</td>
						<td><input type="text" name="notes" id="idinputnotes"></input></td>
					</tr>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="2">
								<input type="reset" value="Clear"></input>
								<input type="submit" value="Submit" class="loginsubmit"></input>
							</td>
						</tr>
					</tfoot>
				</table>
			</form>
		</div>
		<div class="hidden wideborder curvedblock" id="adddialog">
			<div class="errormsg"></div>
			<form id="adddialogform">
				<input type="hidden" name="addname" value=""/>
				<table class="noborder">
					<thead>
						<tr>
							<td colspan="2"  id="adddialogtitle"></td>
						</tr>
					</thead>
					<tbody id="adddialogbody">
					</tbody>
					<tfoot>
						<tr>
							<td colspan="2">
								<input type="reset" value="Clear"></input>
								<input type="submit" value="Submit" class="addsubmit"></input>
							</td>
						</tr>
					</tfoot>
				</table>
			</form>
		</div>
		<script type="text/javascript">
			jQuery('#loginlink').live('click', showlogin);
			jQuery('#logoutlink').live('click', logout);
			jQuery('div.menu .linkable').live('click', menuitemclick);
			jQuery('span.linkable').live('click', showadditem);
			var strFkTableNameValue = "empty";

			
			function additem(dialog) {
				var name = jQuery('input[name="addname"]:hidden').val();
				
				// prepare Options Object
				var options = {
					url: name,
					type: 'POST',
					success: function(responseXML, statusText, xhr, form) {
						//alert('Success: ' + statusText);
						getItemList(name);
						jQuery.modal.close();
					},
					error: function(responseXML, statusText, xhr, form) {
						alert('Error: ' + statusText);
					}
				};

				// pass options to ajaxForm
				jQuery('#adddialogform').ajaxForm(options);
			}

			function addJsonAccepts(req) {
				req.setRequestHeader("Accept", "application/json");
			}
			
			function checkLogin() {
				jQuery.ajax({
					url: 'user',
					type: 'GET',
					success: processUser,
					error: showlogin
				});
			}
			
			function customize(oDataTable, table) {
				if ("scannerlog" == table.name)
					customizeScannerLog(oDataTable, table);
			}
			
			function customizeScannerLog(oDataTable, table) {
				// Add controls for scannerlog notes
				var nCloneTh = document.createElement( 'th' );
				var nCloneTd = document.createElement( 'td' );
				nCloneTd.innerHTML = '<img src="images/details_open.png" /><span id="idSpanNotes" />';
				nCloneTd.className = "center";
				$('#example thead tr').each( function () {
					this.appendChild( nCloneTh.cloneNode(true));
				} );
	
				$('#example tbody tr').each( function () {
					var object = oDataTable.fnGetData(this);
					nCloneTd.innerHTML = '<img id="' + object[0] + '" src="images/details_open.png" /><span id="notes-' + object[0] + '" />';
					this.appendChild(  nCloneTd.cloneNode( true ));
				} );
			}			
			
			function display(table, object) {
				var strHtml = '';

				for (index in table.column) {
					var column = table.column[index];

					strHtml += column.name + '=' + object[column.name] + '<br/>';
				}

				return strHtml;
			}

			function displaylist(responseObj, statusText, xhr) {
				var columns = getobjectoptions(responseObj.name);

				// alert('Options for: ' + columns.table.name);

				//var strHtml = '';
				//for (index in responseObj.objects) {
				//	var object = responseObj.objects[index];
				//	strHtml += display(columns.table, object);
				//}
				//jQuery('div#fieldcontent').html(strHtml);

				displayTable("div#fieldcontent", columns.table, responseObj.objects);
			}
			
			function displayTable(field, table, objects) {
				var tablecolumns = getTableColumns(table);
				var data = new Array();

				// loop through all the objects
				for (index in objects) {
					var object = objects[index];
					var dataObject = new Array();
					data[index] = dataObject;

					for (indexColumn in table.column) {
						var column = table.column[indexColumn];
						
						// check for an idRefs and replace foreign key with the value
						// from the 'name' field of the record associated with the
						// foreign key.
						if ("idref" == column.type) {
							var strGuid = object[column.name];
							var nTokenLocation = column.name.indexOf("id");
							var strFkTable = column.name.substring(0, nTokenLocation);
							var strUrl = strFkTable + '/' + strGuid;

							jQuery.ajax({
								async: false,
								type: 'GET',
								url: strUrl,
								success: replaceGuidWithMeaningfulString
							});
							dataObject[indexColumn] = strFkTableNameValue;
						}
						else
							dataObject[indexColumn] = object[column.name];
					}
				}

				// add a blank table first
				jQuery(field).html('<table class="dataTables_content noborder" id="example"></table>');
				// use the tool to load that table
				var options = {
						"aaData": data,
						"aoColumns": tablecolumns,
						"bAutoWidth": false
				};
				var oDataTable = jQuery('#example').dataTable(options);

				customize(oDataTable, table);				
			}
			
			function getItemList(item) {
				// set the title of the field to the same as the menu item
				jQuery('#fieldtitle').html(item + ' <span class="curvedblocksmall linkable shrink" type="' + item + '">+ Add</span>');

				//alert('getItemList: ' + item);
				jQuery.ajax({
					type: 'GET',
					url: item,
					datatype: 'json',
					beforeSend: addJsonAccepts,
					success: displaylist,
					error: function(responseXML, statusText, xhr, form) {
						alert('Item ' + item + ' error: ' + statusText);
					}
				});
			}

			var objectoptions = new Object();
			function getobjectoptions(name) {
				var options = objectoptions[name];

				if (typeof(options) == 'undefined') {
					jQuery.ajax({
						type: 'OPTIONS',
						url: 'database/' + name,
						datatype: 'json',
						async: false,
						beforeSend: addJsonAccepts,
						success: function(responseObj) {
							//alert('Retrieved options for ' + responseObj.table.name);
							objectoptions[name] = responseObj;
						},
						error: function(responseXML, statusText, xhr, form) {
							alert('Error getting options for ' + name + ': ' + statusText);
						}
					});
				}

				return objectoptions[name];
			}
			
			function getrow(column) {
				var row;
				
				if (column.type != "id" && column.type != 'date') {
					row = jQuery(document.createElement('tr'));

					var labelCell = jQuery(document.createElement('td'));
					row.append(labelCell);
					labelCell.text(column.name + ':');
					var inputCell = jQuery(document.createElement('td'));
					row.append(inputCell);
					var input = jQuery(document.createElement('input'));

					input.attr('name', column.name);
					// set the type of input
					if (column.type == "password" || column.name == "password") {
						input.attr('type', 'password');
					} else {
						input.attr('type', 'text');
					}
					inputCell.append(input);
				} 

				return row;
			}

			function getTableColumns(table) {
				var tablecolumns = new Array();

				// find the column definitions
				for (index in table.column) {
					var column = table.column[index];
					
					if (column.type == "id") {
						tablecolumns[index] = {"sTitle": column.name, "bVisible": false }
					} else if (column.type == "password" || column.name == "password") {
						tablecolumns[index] = {"sTitle": column.name, fnRender: renderPassword }
					} else {
						tablecolumns[index] = {"sTitle": column.name }
					}
				}
				
				return tablecolumns;
			}
			
			function loginerror(responseXML, statusText, xhr, form) {
				if (204 == responseXML.status) {
					seterrormsg('Invalid login. Please try again.');
				}
				else {
					alert('login error: ' + statusText + "-" + xhr.responseText);
				}
			}

			function loginsuccess(responseXML, statusText, xhr, form) {
//				alert('login success: ' + statusText);
				processUser(responseXML);
				jQuery.modal.close();
			}

			function logout() {
				jQuery.ajax({
					url: 'user',
					type: 'DELETE',
					success: function() {
						jQuery('span#loginlink').html('No User');

						checkLogin();
					},
					error: function(responseXML, statusText, xhr, form) {
						alert('logout error: ' + statusText);
					}
				});
			}
			
			function menuitemclick(event) {
				var menuitem = event.target.innerHTML;

				// get the item list based on the menu item
				menuitem = menuitem.toLowerCase();
				getItemList(menuitem);
			}

			function noteserror(responseXML, statusText, xhr, form) {
				if (204 == responseXML.status) {
					seterrormsg('Problem processing notes');
				}
				else {
					alert('notes error: ' + statusText + "-" + xhr.responseText);
				}
			}
			
			function onshowlogin() {
				// prepare Options Object
				var options = {
					url: 'user',
					type: 'PUT',
					dataType: 'xml',
					success: loginsuccess,
					error: loginerror
				};

				// pass options to ajaxForm
				jQuery('#logindialogform').ajaxForm(options);
			}

			
			function populateAddItemForm(name) {
				jQuery('#adddialogtitle').html('New ' + name);
				jQuery('input[name="addname"]:hidden').attr('value', name);

				var body = jQuery("tbody#adddialogbody");
				body.empty();

				var columns = getobjectoptions(name);
				var table = columns.table;

				// find the column definitions
				for (index in table.column) {
					row = getrow(table.column[index]);

					if (typeof(row) != 'undefined') {
						body.append(row);
					}
				}
			}

			function processNotes(responseXML, statusText, xhr, form) {
				var strScannerLogId;
				var strComment;
				
				jQuery(responseXML).find("field").each(function() {
					if (jQuery(this).attr('name') == "scannerlogid")
						strScannerLogId = jQuery(this).text();
					else if (jQuery(this).attr('name') == "comment")
						strComment = jQuery(this).text();
				});

				// Display the note that was just persisted
				var strSpanId = "span#notes-" + strScannerLogId;
				jQuery(strSpanId).html(strComment);
				
				// Close the layer
				jQuery.modal.close();

			}
			
			function processUser(xml) {
				var firstName;
				var lastName;

				jQuery(xml).find("field").each(function() {
					if (jQuery(this).attr('name') == "firstname") {
						firstName = jQuery(this).text();
					} else if (jQuery(this).attr('name') == "lastname") {
						lastName = jQuery(this).text();
					}
				});

				jQuery('span#loginlink').html(firstName + ' ' + lastName);
			}

			function renderPassword(obj) {
				return "****";
			}

			function replaceGuidWithMeaningfulString(data) {
				strFkTableNameValue = "";
				jQuery(data).find('object').each(function() {
					if ("staff" == jQuery(this).attr("name"))
						strFkTableNameValue = jQuery(this).children("field[name='lastname']").text();
					else if ("compliancevalue" == jQuery(this).attr("name"))
						strFkTableNameValue = jQuery(this).children("field[name='value']").text();
					else if ("offender" == jQuery(this).attr("name"))
						strFkTableNameValue = jQuery(this).children("field[name='lastname']").text();
					else
						strFkTableNameValue = jQuery(this).children("field[name='name']").text();
				});
			}

			function showadditem(event) {
				var name = event.target.attributes['type'].value;
				//alert("Ping: " + name);
				populateAddItemForm(name);
				jQuery("#adddialog").modal({
					opacity:80,
					overlayCss: {
						backgroundColor:"#EEEEEE"
					},
					containerCss: {
						backgroundColor:"#EEEEEE",
					},
					onShow: additem
				});
			}

			function showlogin() {
				jQuery("#logindialog").modal({
					opacity:70,
					overlayCss: {
						backgroundColor:"#EEEEEE"
					},
					containerCss: {
						backgroundColor:"#EEEEEE",
					},
					onShow: onshowlogin
				});
			}

			function shownotes() {
				$('#example tbody td img').live('click', function () {
					var strScannerLogId = jQuery(this).attr('id');
					
					jQuery("#notesdialog").modal({
						opacity:70,
						overlayCss: {
							backgroundColor:"#EEEEEE"
						},
						onShow: function (dialog) {
							var modal = this;
							jQuery("#idhiddenscannerlogguid").attr('value', strScannerLogId);

							// prepare Options Object
							var options = {
								url: 'scannerlogcomment',
								type: 'POST',
								dataType: 'xml',
								success: processNotes,
								error: noteserror
							};

							// pass options to ajaxForm
							jQuery('#notesdialogform').ajaxForm(options);
						}
					});
				} );		
				
			}
			
			jQuery(document).ready(function() {
				// when the page first comes up, check for a logged in user
				checkLogin();

				// Set up the click handler for scannerlogcomment entries
				shownotes();
			});


			
			

			</script>
	</body>
</html>